#!/usr/bin/env bash

read -r -d '' JQ_SCRIPT << EOM
select(.reason=="compiler-message") |
.message.span=(.message.spans | map(select(.is_primary)) | .[0]) |
{
  code:.message.code.code,
  file:.message.span.file_name,
  line:.message.span.line_start,
  text: .message.span.text | map(.text)
}
EOM

(
  cargo clippy \
    --no-deps --message-format=json -- \
    -D clippy::unwrap_used -D clippy::expect_used -D clippy::panic \
    -D clippy::unreachable -D clippy::unimplemented -D clippy::todo \
    -D clippy::exit \
    2>/dev/null
) | jq "$JQ_SCRIPT"
